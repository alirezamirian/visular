angular.module("visular",["visular.config","visular.core","visular.guideline","visular.resizeHandles","sugarSvg","visular.zoom"]),angular.module("visular.config",[]).provider("vzConfig",function(){this.markupPath="templates",this.setMarkupPath=function(e){this.markupPath=e},this.$get=function(){return this}}),angular.module("visular.core",["visular.config"]).value("VZ_THRESHOLD",.001),angular.module("visular.guideline",[]).directive("vzGuideline",["VzGuidelineFactory",function(e){var t='<div class="vz-guideline"   ng-repeat="guideline in guidelines"   ng-class="guideline.isHorizontal() ? \'vz-guideline-h\' : \'vz-guideline-v\'"   ng-style="{       top: guideline.isHorizontal() ? guideline.level : 0,       left: !guideline.isHorizontal() ? guideline.level : 0}"></div>';return{restrict:"A",require:"vzDiagram",link:function(){function i(t){function i(e){return e!=t}function n(e){return e.getBBox()}s=e.create(g.rect(0,0,o.elem.width(),o.elem.height()),o.diagram.elements.filter(i).map(n),t.getBBox()),a.guidelines=s.activeGuidelines}function n(){delete s,a.guidelines=[]}function r(e){return s.moveTargetToPosition(e),s.guidedTargetRect.origin()}var o=arguments[arguments.length-2],a=o.addOverlay(t),s=null;o.addElementPositionInterceptor(r,i,n)}}}]).factory("VzGuidelineFactory",function(){function e(e,t){this.type=e,this.level=t,this.isHorizontal=function(){return this.type==i.Types.BOTTOM||this.type==i.Types.H_MIDDLE||this.type==i.Types.TOP}}function t(t,n,r){this.THRESHOLD=10;var o=[];o.push(new e(i.Types.H_MIDDLE,t.height/2)),o.push(new e(i.Types.TOP,0)),o.push(new e(i.Types.BOTTOM,t.height)),o.push(new e(i.Types.V_MIDDLE,t.width/2)),o.push(new e(i.Types.LEFT,0)),o.push(new e(i.Types.RIGHT,t.width)),angular.forEach(n,function(t){o.push(new e(i.Types.H_MIDDLE,t.y+t.height/2)),o.push(new e(i.Types.TOP,t.y)),o.push(new e(i.Types.BOTTOM,t.y+t.height)),o.push(new e(i.Types.V_MIDDLE,t.x+t.width/2)),o.push(new e(i.Types.LEFT,t.x)),o.push(new e(i.Types.RIGHT,t.x+t.width))}),r=angular.copy(r),this.guidedTargetRect=angular.copy(r),this.activeGuidelines=[],this.moveTargetToPosition=function(e){this.activeGuidelines.length=0,r.y=e.y,r.x=e.x;for(var t=null,n=null,a=0;a<o.length&&(!t||!n);a++){var s=o[a];switch(s.type){case i.Types.H_MIDDLE:Math.abs(r.y+r.height/2-s.level)<this.THRESHOLD&&(t=s,this.guidedTargetRect.y=s.level-r.height/2,this.activeGuidelines.push(s));break;case i.Types.TOP:Math.abs(r.y-s.level)<this.THRESHOLD&&(t=s,this.guidedTargetRect.y=s.level,this.activeGuidelines.push(s));break;case i.Types.BOTTOM:Math.abs(r.y+r.height-s.level)<this.THRESHOLD&&(t=s,this.guidedTargetRect.y=s.level-r.height,this.activeGuidelines.push(s));break;case i.Types.V_MIDDLE:Math.abs(r.x+r.width/2-s.level)<this.THRESHOLD&&(n=s,this.guidedTargetRect.x=s.level-r.width/2,this.activeGuidelines.push(s));break;case i.Types.LEFT:Math.abs(r.x-s.level)<this.THRESHOLD&&(n=s,this.guidedTargetRect.x=s.level,this.activeGuidelines.push(s));break;case i.Types.RIGHT:Math.abs(r.x+r.width-s.level)<this.THRESHOLD&&(n=s,this.guidedTargetRect.x=s.level-r.width,this.activeGuidelines.push(s))}}t||(this.guidedTargetRect.y=r.y),n||(this.guidedTargetRect.x=r.x)}}var i={create:function(e,i,n){return new t(e,i,n)},Types:{TOP:1,H_MIDDLE:2,BOTTOM:3,LEFT:4,V_MIDDLE:5,RIGHT:6}};return i}),function(e){"use strict";e.module("visular.resizeHandles",["visular.core"])}(angular),function(e){"use strict";function t(){return{restrict:"A",compile:function(e){e.attr("dx","50%"),e.attr("dy","50%"),e.attr("text-anchor","middle"),e.attr("dominant-baseline","middle")}}}e.module("sugarSvg",[]).directive("ssTextCenter",t)}(angular),function(e){function t(){var e=.1;return{restrict:"A",require:"vzDiagram",link:function(t,i,n,r){function o(i){var n=r.elem.offset(),o=i.originalEvent.pageX-n.left,a=i.originalEvent.pageY-n.top,s=!1;(l.x!=o||l.y!=a)&&(console.log("position changed"),s=!0);var u=i.originalEvent.deltaY;r.zoom.center;return t.$apply(function(){r.zoom.factor*=1-e*u,s&&(r.zoom.center.x=r.zoom.center.x+(o-r.zoom.center.x)/r.zoom.factor,r.zoom.center.y=r.zoom.center.y+(a-r.zoom.center.y)/r.zoom.factor)}),l.x=o,l.y=a,!1}function a(){i.bind("wheel",o)}function s(){i.unbind("wheel",o)}t.$on("$destroy",s),a();var l={x:0,y:0}}}}e.module("visular.zoom",[]).directive("vzZoom",t)}(angular),function(){"use strict";function e(){return function(e){this.type=e||"default",this.id="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,i="x"==e?t:3&t|8;return i.toString(16)}),this.position={x:0,y:0},this.size={width:100,height:100},this.getBBox=function(){return g.rect(this.position.x,this.position.y,this.size.width,this.size.height).bbox(this.rotation)},this.getRect=function(){return g.rect(this.position.x,this.position.y,this.size.width,this.size.height)},this.resizable=!0,this.rotation=0}}function t(e,t,i,n,r){return{restrict:"A",require:"^vzDiagram",scope:{model:"=vzElement"},template:'<svg class="vz-element"                 ng-class="{\'vz-selected\': vzDiagram.isSelected(model)}"                ng-attr-width="{{model.size.width}}"                 ng-attr-height="{{model.size.height}}"                 ng-attr-x="{{model.position.x}}"                 ng-attr-y="{{model.position.y}}"                 ng-include="markupUrl()">            </svg>',link:function(t,n,r,o){function a(){t.$apply(function(){o.bringToFront(t.model)})}function s(){t.$apply(function(){o.select(t.model)})}t.vzDiagram=o,t.markupUrl=function(){return e.markupPath+"/"+t.model.type+".svg"},t.scaleX=1,t.scaleY=1,t.$watch(function(){return n.get(0).getBBox().height.toFixed(1)},function(e,t){console.log(t+" => "+e)}),n.bind("mousedown",a),t.$on("$destroy",function(){n.unbind("mousedown",a)}),n.bind("mouseup",s),t.$on("$destroy",function(){n.unbind("mouseup",s)}),new i(n,o.elem).onDragStart(function(e){o.drag.started(t.model,e)}).onDragFinish(function(e){o.drag.finished(t.model,e)}).onDrag(function(e){o.drag.to(g.point(this.draggedPosition.x,this.draggedPosition.y),t.model,e)})}}}angular.module("visular.core").factory("VzElementModel",e).directive("vzElement",t),t.$inject=["vzConfig","$document","VzDraggableFactory","$timeout","VZ_THRESHOLD"]}(),function(){"use strict";function e(){return function(e){this.source=null,this.target=null,this.middlePoints=[]}}function t(){return{restrict:"A",require:"^vzDiagram",scope:{model:"=vzLink"},template:'<g class="vz-link">   <path class="vz-link-path" stroke="#888" ng-attr-d="{{path()}}"></path>   <path   class="vz-link-arrow"            stroke="#666" d="M 10 0 L 0 5 L 10 10 z"           ng-attr-transform="               translate({{targetArrow.translate.x}}, {{targetArrow.translate.y}})                rotate({{targetArrow.rotation}})"></g>',link:function(e,t,i,n){function r(){if(e.startPoint){e.targetArrow.rotation=180-e.startPoint.theta(e.endPoint);var t=e.targetArrow.rotation*(Math.PI/180),i=10;e.targetArrow.translate.x=e.endPoint.x+i/2*Math.sin(t),e.targetArrow.translate.y=e.endPoint.y-i/2*Math.cos(t)}}e.srcElem=null,e.targetElem=null,e.startPoint=new g.point(0,0),e.endPoint=new g.point(0,0),e.targetArrow={rotation:0,translate:{x:0,y:0}},e.$watch("model.source.id",function(){e.srcElem=n.diagram.elementsById[e.model.source.id]}),e.$watch("model.target.id",function(){e.targetElem=n.diagram.elementsById[e.model.target.id]}),e.$watch("[targetElem.position, targetElem.size, srcElem.position, srcElem.size]",function(){e.targetElem&&e.srcElem&&(e.startPoint=e.srcElem.getBBox().intersectionWithLineFromCenterToPoint(e.targetElem.getBBox().center()),e.endPoint=e.targetElem.getBBox().intersectionWithLineFromCenterToPoint(e.srcElem.getBBox().center()),r())},!0),e.path=function(){var t=[];return e.startPoint&&t.push(e.startPoint),e.endPoint&&t.push(e.endPoint),"M "+t.map(function(e){return e.x+" "+e.y}).join(" ")}}}}angular.module("visular.core").factory("VzLinkModel",e).directive("vzLink",t)}(),function(){function e(e){return function(t,i){function n(n){return u.startPosition={x:n.pageX,y:n.pageY},u.localOffset={x:u.startPosition.x-t.offset().left,y:u.startPosition.y-t.offset().top},l=i.offset(),l.bottom=l.top+i.height(),l.right=l.left+i.width(),angular.isFunction(a)&&c.$apply(function(){a.call(u,n)}),e.bind("mousemove",r),e.one("mouseup",function(){e.unbind("mousemove",r),angular.isFunction(s)&&c.$apply(function(){s.call(u,n)})}),!1}function r(e){u.position={x:e.pageX,y:e.pageY};var t=Math.min(Math.max(e.pageX,l.left),l.right),i=Math.min(Math.max(e.pageY,l.top),l.bottom);u.draggedPosition={x:t-u.localOffset.x-l.left,y:i-u.localOffset.y-l.top},angular.isFunction(o)&&c.$apply(function(){o.call(u,e)})}var o,a,s,l,u=this;t=angular.element(t),i=i?angular.element(i):e;var c=t.scope();t.bind("mousedown",n),c.$on("$destroy",function(){t.unbind("mousedown",n)}),this.onDrag=function(e){return o=e,this},this.onDragStart=function(e){return a=e,this},this.onDragFinish=function(e){return s=e,this}}}angular.module("visular.core").factory("VzDraggableFactory",e),e.$inject=["$document"]}(),function(e){"use strict";function t(e){var t=10;return{restrict:"E",require:"^vzDiagram",link:function(i,n,r,o){var a,s={};new e(n,o.elem).onDragStart(function(){a=o.selectedItem.getRect(),s.top=o.elem.offset().top+a.y,s.left=o.elem.offset().left+a.x}).onDrag(function(e){var i=g.rect(a),n=r.vzOverlayHandle.toLowerCase();n.indexOf("top")>-1&&(i.height=Math.max(s.top+a.height-e.pageY,t),i.y=a.y+a.height-i.height),n.indexOf("bottom")>-1&&(i.height=Math.max(e.pageY-s.top,t)),n.indexOf("left")>-1&&(i.width=Math.max(s.left+a.width-e.pageX,t),i.x=a.x+a.width-i.width),n.indexOf("right")>-1&&(i.width=Math.max(e.pageX-s.left,t)),o.resizeElement(i,o.selectedItem,e)})}}}e.module("visular.resizeHandles").directive("vzResizeHandle",t),t.$inject=["VzDraggableFactory"]}(angular),function(e){"use strict";function t(){return{restrict:"A",require:"vzDiagram",compile:function(e){e.append('<div vz-selected-item-overlay>   <vz-resize-handle vz-overlay-handle="top left"></vz-resize-handle>   <vz-resize-handle vz-overlay-handle="top"></vz-resize-handle>   <vz-resize-handle vz-overlay-handle="top right"></vz-resize-handle>   <vz-resize-handle vz-overlay-handle="right"></vz-resize-handle>   <vz-resize-handle vz-overlay-handle="bottom right"></vz-resize-handle>   <vz-resize-handle vz-overlay-handle="bottom"></vz-resize-handle>   <vz-resize-handle vz-overlay-handle="bottom left"></vz-resize-handle>   <vz-resize-handle vz-overlay-handle="left"></vz-resize-handle></div>')}}}e.module("visular.resizeHandles").directive("vzResizeHandles",t)}(angular),function(){"use strict";function e(e,t){return function(){this.elements=[],this.links=[],this.elementsById={},this.addElement=function(t){t instanceof e&&(this.elements.push(t),this.elementsById[t.id]=t)},this.addLink=function(e,i){var n=new t;n.source=e,n.target=i,this.links.push(n)}}}function t(){return{restrict:"A",require:"^vzDiagram",link:function(e,t,i,n){function r(){return n.selectedItem}function o(){return n.selectedItem?n.selectedItem.size:null}function a(){return n.selectedItem?n.selectedItem.position:null}e.$watch(r,function(e){e?t.show():t.hide()}),e.$watch(a,function(e){t.css("top",e?e.y:-1e4),t.css("left",e?e.x:-1e4)},!0),e.$watch(o,function(e){t.css("width",e?e.width:1),t.css("height",e?e.height:1)},!0)}}}function i(e,t){function i(e,i,n,r){i.bind("mousedown",function(t){t.target==r.rootSvgElem.get(0)&&e.$apply(function(){r.unSelect()})}),n.vzDiagramController&&t(n.vzDiagramController).assign(e.$parent,e.vz)}return{restrict:"E",scope:!0,transclude:!0,template:'<svg >   <g>       <g ng-repeat="link in vz.diagram.links" vz-link="link"></g>       <g ng-repeat="elem in vz.diagram.elements" vz-element="elem"></g>   </g></svg><div ng-transclude></div>',controller:["$element","$scope","$attrs",function(i,n,r){var o=[],a=[];this.elem=i,this.rootSvgElem=i.find("svg:first"),this.viewport=this.rootSvgElem.find(">g:first");var s=this;n.$watch(r.vzDiagramModel,function(){s.diagram=t(r.vzDiagramModel)(n)}),this.bringToFront=function(e){var t=this.diagram.elements.indexOf(e);t>-1&&(this.diagram.elements.splice(t,1),this.diagram.elements.push(e))},this.isSelected=function(e){return this.selectedItem==e},this.select=function(e){this.selectedItem=e},this.unSelect=function(){this.selectedItem=null},this.drag={started:function(e,t){o.forEach(function(i){i.movementStartHandler(e,t)})},finished:function(e,t){o.forEach(function(i){i.movementFinishHandler(e,t)})},to:function(e,t,i){var n=e;o.forEach(function(e){n=e.interceptor(n,t,i)}),t.position.x=n.x,t.position.y=n.y}},this.resizeElement=function(e,t,i){var n=e;a.forEach(function(e){n=e.interceptor(n,t,i)}),t.size.width=n.width,t.size.height=n.height,t.position.x=n.x,t.position.y=n.y},this.addElementPositionInterceptor=function(e,t,i){o.push({interceptor:e||angular.identity,movementStartHandler:t||angular.noop,movementFinishHandler:i||angular.noop})},this.addElementResizeInterceptor=function(e){e.push({interceptor:e||angular.identity})},this.addOverlay=function(t){var r=n.$new(),o=angular.element(t).appendTo(i);return e(o)(r),r},this.zoom=1,this.pan={x:0,y:0},this.getTransformMatrix=function(){var e=s.rootSvgElem[0].createSVGMatrix();return e},n.$watch(this.getTransformMatrix,function(e){if(e){console.log("transformation changed",e);"matrix("+e.a+","+e.b+","+e.c+","+e.d+","+e.e+","+e.f+")"}},!0)}],controllerAs:"vz",compile:function(){return i}}}angular.module("visular.core").factory("VzDiagramModel",e).directive("vzDiagram",i).directive("vzSelectedItemOverlay",t),e.$inject=["VzElementModel","VzLinkModel"],i.$inject=["$compile","$parse"]}();